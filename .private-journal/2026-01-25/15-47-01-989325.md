---
title: "3:47:01 PM - January 25, 2026"
date: 2026-01-25T23:47:01.989Z
timestamp: 1769384821989
---

## Project Notes

Deep dive on the id_above logic:

The algorithm in fetcher.py line 73-77:
```python
# Start next batch with id_above set to highest ID from this batch
if results:
    id_above = max(taxon['id'] for taxon in results)
else:
    break
```

This is problematic because `results` here refers ONLY to the final page's results from the inner while loop. The issue:

1. The inner loop breaks at line 71 when batch_count >= MAX_RESULTS_PER_SEARCH - per_page
2. When per_page=200, this means breaking when batch_count >= 9800
3. The final iteration of the inner loop might have batch_count between 9800-9999
4. `results` is the API response from that final page (1 page, up to 200 items)
5. `max(taxon['id'] for taxon in results)` gets the max ID from ONLY that page

CRITICAL ISSUE: If results are not sorted by ID, and a later page has lower IDs than an earlier page in the same batch, we could miss data or get duplicates.

However, looking at the test mock setup and the real API behavior: the API likely returns results sorted by ID. But this assumption is NOT documented in the code and is a hidden dependency.

ALSO, there's another issue at line 75: what if the inner loop never executes? If id_above is set to some value, but then results come back empty on the first page of the next batch (which shouldn't happen but could), we'd break without moving id_above further, creating an infinite loop potential... wait, that's handled by the "if not results: return" check on line 50-52.

Actually, looking more carefully:
- Line 74: `if results:` means results is truthy (non-empty)
- But after line 73, results could be from a page that only has 1 item, or partially empty
- So max() would find the max from that final page

If the final page returned {100, 101, 102} and we set id_above=102, then on the next batch we'll get results > 102. That's correct.

But what if the data isn't sorted by ID? Let me think...

If previous pages had {501-700}, and the final page (before break) had {480-499}, then max() would return 499, and we'd continue from there. But we've already yielded 500-700! Those are duplicates now.

Actually... I think I'm overcomplicating this. The real issue is simpler: the code assumes the API returns results in ID ascending order, which is reasonable given how iNaturalist API works. But this should be documented.

Wait, let me re-examine the test more carefully...

